From: Juho Vähä-Herttua <juhovh@iki.fi>
Date: Tue, 17 Jun 2008 16:33:43 +0000 (+0800)
Subject: BUG(1988): Fix wma file playing with newer libavcodec.
X-Git-Url: http://git.xmms.se/?p=xmms2-devel.git;a=commitdiff_plain;h=be6f8e111913433a0fee1ddfa3d234067695aadf

BUG(1988): Fix wma file playing with newer libavcodec.
---

diff --git a/src/plugins/asf/asf.c b/src/plugins/asf/asf.c
index 13b1e9d..4c01d29 100644
--- a/src/plugins/asf/asf.c
+++ b/src/plugins/asf/asf.c
@@ -396,6 +396,10 @@ xmms_asf_get_track (xmms_xform_t *xform, asf_file_t *file)
 			                            wfx->cbSize);
 
 			xmms_xform_auxdata_set_int (xform,
+			                            "block_align",
+			                            wfx->nBlockAlign);
+
+			xmms_xform_auxdata_set_int (xform,
 			                            "bitrate",
 			                            data->bitrate);
 
diff --git a/src/plugins/avcodec/avcodec.c b/src/plugins/avcodec/avcodec.c
index 4c4c794..e878793 100644
--- a/src/plugins/avcodec/avcodec.c
+++ b/src/plugins/avcodec/avcodec.c
@@ -41,6 +41,7 @@ typedef struct {
 
 	gint bitrate;
 	gint samplebits;
+	gint block_align;
 	const gchar *codec_id;
 	gpointer extradata;
 	gssize extradata_size;
@@ -154,6 +155,10 @@ xmms_avcodec_init (xmms_xform_t *xform)
 	                            "samplebits",
 	                            &data->samplebits);
 
+	xmms_xform_auxdata_get_int (xform,
+	                            "block_align",
+	                            &data->block_align);
+
 	ret = xmms_xform_auxdata_get_bin (xform,
 	                                  "decoder_config",
 	                                  &data->extradata,
@@ -169,6 +174,7 @@ xmms_avcodec_init (xmms_xform_t *xform)
 	data->codecctx->channels = data->channels;
 	data->codecctx->bit_rate = data->bitrate;
 	data->codecctx->bits_per_sample = data->samplebits;
+	data->codecctx->block_align = data->block_align;
 	data->codecctx->extradata = data->extradata;
 	data->codecctx->extradata_size = data->extradata_size;
 
@@ -254,9 +260,6 @@ xmms_avcodec_read (xmms_xform_t *xform, xmms_sample_t *buf, gint len,
 		if (bytes_read < 0) {
 			XMMS_DBG ("Error decoding data!");
 			return -1;
-		} else if (bytes_read == 0) {
-			/* FIXME: this is a hack for wma to work without block_align */
-			data->buffer_length = 0;
 		}
 
 		data->buffer_length -= bytes_read;
